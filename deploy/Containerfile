# SPDX-License-Identifier: MPL-2.0
# Containerfile for HAR (Hybrid Automation Router)
# Compatible with: nerdctl, podman, docker
# Build: nerdctl build -t har:latest -f deploy/Containerfile .
#        podman build -t har:latest -f deploy/Containerfile .
#        docker build -t har:latest -f deploy/Containerfile .

# =============================================================================
# Stage 1: Build
# =============================================================================
FROM docker.io/hexpm/elixir:1.16.0-erlang-26.2.1-alpine-3.19.0 AS builder

# Install build dependencies
RUN apk add --no-cache \
    git \
    build-base \
    npm

# Set build environment
ENV MIX_ENV=prod \
    LANG=C.UTF-8

WORKDIR /app

# Install hex and rebar
RUN mix local.hex --force && \
    mix local.rebar --force

# Copy dependency files first (better layer caching)
COPY mix.exs mix.lock ./
COPY config config

# Fetch and compile dependencies
RUN mix deps.get --only prod && \
    mix deps.compile

# Copy application source
COPY lib lib
COPY priv priv

# Compile application
RUN mix compile

# Build release
RUN mix release

# =============================================================================
# Stage 2: Runtime
# =============================================================================
FROM docker.io/alpine:3.19 AS runtime

# Install runtime dependencies
RUN apk add --no-cache \
    libstdc++ \
    openssl \
    ncurses-libs \
    ca-certificates \
    curl

# Security: non-root user
RUN addgroup -g 1000 har && \
    adduser -u 1000 -G har -s /bin/sh -D har

WORKDIR /app

# Copy release from builder
COPY --from=builder --chown=har:har /app/_build/prod/rel/har ./

# Copy routing table and examples
COPY --chown=har:har priv/routing_table.yaml ./priv/
COPY --chown=har:har examples ./examples/

USER har

# Expose ports
# - 4000: Phoenix web interface (future)
# - 4369: EPMD (Erlang Port Mapper Daemon)
# - 9100-9155: Distributed Erlang
EXPOSE 4000 4369 9100-9155

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:4000/health || exit 1

# Environment
ENV RELEASE_COOKIE=har_cluster_cookie \
    RELEASE_NODE=har@127.0.0.1 \
    PHX_HOST=localhost \
    PHX_SERVER=true \
    PORT=4000

# Entrypoint
ENTRYPOINT ["bin/har"]
CMD ["start"]
